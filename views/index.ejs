<html>
    <body onload="myFunction()">
        <link rel="stylesheet" href="style.css">
        <header id="header">
            Stock Price Alerter
        </header>
            <form action='/new' method="POST">
                <input type="text" id="stockId" name="stockId" placeholder="StockId" required>
                <input type="text" id="lowerLimit" name="lowerLimit" placeholder="lowerLimit">
                <input type="text" id="upperLimit" name="upperLimit" placeholder="upperLimit">
                <button type="submit">Submit</button>
            </form>
        <hr>
        <h1>Stocks to Watch</h1>       
        <div id="allStocks">
            <%items.stocks.forEach(function(item){%>
                <div class="flexContainer">
                    <div ><%= item.stockId %></div>
                    <div ><%= item.lowerLimit %></div>
                    <button onclick="changeLowerLimit()" class="btn">ChangeLowerLimits</button>
                    <div ><%= item.upperLimit %></div>
                    <button onclick="changeUpperLimit()" class="btn">ChangeUpperLimits</button>
                    <div ><%= item.currentPrice %></div>
                </div>
            <%})%>
        </div>        
        <script>
            var btns=document.getElementsByClassName("btn");
            var counter = 1;
            for (var i=0;i<btns.length;i++){
                btns[i].id=(counter++);
            }
        </script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script>
            function myFunction() {
              setInterval(function(){
                const Http = new XMLHttpRequest();
                const url='http://localhost:4001/update';
                Http.open("GET", url);
                Http.send();
                Http.onreadystatechange = (e) => {
                  console.log(Http.responseText)
                  console.log("updated");
                  location.reload();
                }
                },20000);
            };                  
            function changeLowerLimit(){
                var btnId=this.event.target.id;
                var price = prompt("Enter new lower limit");
                document.getElementById(btnId).previousElementSibling.innerHTML = price;
                const data = ({
                    "stockId":document.getElementById(btnId).previousElementSibling.previousElementSibling.innerHTML,
                    "lowerLimit":document.getElementById(btnId).previousElementSibling.innerHTML,
                    "upperLimit":document.getElementById(btnId).nextElementSibling.innerHTML
                })
                console.log(data);
                const jsonString = JSON.stringify(data);
                fetch('/change',{
                    method: 'POST' ,
                    headers:{
                        'Content-Type':'application/json'},
                    body : jsonString
                })
            }
            function changeUpperLimit(){
                var btnId=this.event.target.id;
                var price = prompt("Enter new upper limit");
                document.getElementById(btnId).previousElementSibling.innerHTML = price;
                const data = ({
                    "stockId":document.getElementById(btnId).previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling.innerHTML,
                    "lowerLimit":document.getElementById(btnId).previousElementSibling.previousElementSibling.previousElementSibling.innerHTML,
                    "upperLimit":document.getElementById(btnId).previousElementSibling.innerHTML
                })
                console.log(data);
                const jsonString = JSON.stringify(data);
                fetch('/change',{
                    method: 'POST' ,
                    headers:{
                        'Content-Type':'application/json'},
                    body : jsonString
                })
            }
            </script>
        </script>      
    </body>
</html>